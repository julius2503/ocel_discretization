<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OCEL-Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .param-group {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .attr-param-block {
            border: 1px solid #ced4da;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }
        .attr-param-block h5 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="mb-4 text-center">OCEL: {{ filename }}</h1>

        <div class="mb-3">
            <a href="{{ url_for('upload_file') }}" class="btn btn-secondary">Anderen Log hochladen</a>
        </div>

        <form method="post" action="{{ url_for('process_attributes') }}">
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Event-/Objektyp</th>
                            <th>Event/Object</th>
                            <th>Attribut</th>
                            <th>Numerisch</th>
                            <th>Auswählen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attribute in attributes %}
                        <tr>
                            <td>{{ attribute[0] }}</td>
                            <td>{{ attribute[1] }}</td>
                            <td>{{ attribute[2] }}</td>
                            <td class="text-center">
                                {% if attribute[3] == 'yes' %}
                                    <span class="text-success fs-5">✔️</span>
                                {% else %}
                                    <span class="text-danger fs-5">❌</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <input type="checkbox" class="attr-checkbox" 
                                       data-objtype="{{ attribute[0] }}" 
                                       data-eventobject="{{ attribute[1] }}" 
                                       data-attribute="{{ attribute[2] }}"
                                       name="selected_attributes" 
                                       value="{{ attribute[0] }},{{ attribute[1] }},{{ attribute[2] }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="config-section mt-4">
                <h2>Algorithmus wählen</h2>

                <div class="mb-3">
                    <select name="algorithm" id="algorithmSelect" class="form-select" onchange="updateParameterForms()">
                        <option value="equal_freq">Equal Frequency Binning</option>
                        <option value="equal_width">Equal Width Binning</option>
                        <option value="chi_merge">ChiMerge</option>
                        <option value="kmeans">k-Means Clustering</option>
                    </select>
                </div>

                <div id="paramsContainer"></div>
            </div>

            <button type="submit" class="btn btn-success mt-4">Diskretisierung starten</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const algorithmSelect = document.getElementById('algorithmSelect');
        const paramsContainer = document.getElementById('paramsContainer');

 
        algorithmSelect.addEventListener('change', updateParameterForms);


        document.querySelectorAll('.attr-checkbox').forEach(cb => {
            cb.addEventListener('change', updateParameterForms);
        });

        function renderParamsForAlgorithm(algorithm, idx) {
            switch(algorithm) {
                case 'equal_freq':
                    return `
                        <div class="param-group" style="display:block;">
                            <label for="bins_${idx}" class="form-label">Anzahl Bins</label>
                            <input type="number" name="params[${idx}][bins]" id="bins_${idx}" min="2" max="10" value="3" class="form-control" />
                        </div>
                    `;
                case 'equal_width':
                    return `
                        <div class="param-group" style="display:block;">
                            <label for="width_${idx}" class="form-label">Intervallbreite</label>
                            <input type="number" name="params[${idx}][width]" id="width_${idx}" step="0.1" value="10" class="form-control" />
                        </div>
                    `;
                case 'chi_merge':
                    return `
                        <div class="param-group" style="display:block;">
                            <label for="alpha_${idx}" class="form-label">Signifikanzniveau</label>
                            <input type="number" name="params[${idx}][alpha]" id="alpha_${idx}" min="0.001" max="0.2" step="0.001" value="0.05" class="form-control" />
                        </div>
                    `;
                case 'kmeans':
                    return `
                        <div class="param-group" style="display:block;">
                            <label for="clusters_${idx}" class="form-label">Anzahl Cluster</label>
                            <input type="number" name="params[${idx}][clusters]" id="clusters_${idx}" min="2" max="10" value="3" class="form-control" />
                        </div>
                    `;
                default:
                    return '';
            }
        }
        function updateParameterForms() {
            const algorithm = algorithmSelect.value;
            const selectedCheckboxes = Array.from(document.querySelectorAll('.attr-checkbox:checked'));
            paramsContainer.innerHTML = '';

            selectedCheckboxes.forEach((cb, idx) => {
                const objtype = cb.dataset.objtype;
                const eventobject = cb.dataset.eventobject;
                const attribute = cb.dataset.attribute;

                const div = document.createElement('div');
                div.classList.add('attr-param-block');
                div.innerHTML = `
                    <h5>Parameter für <strong>${objtype} - ${attribute}</strong></h5>
                    ${renderParamsForAlgorithm(algorithm, idx)}
                `;
                paramsContainer.appendChild(div);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateParameterForms();
        });
    </script>
</body>
</html>
